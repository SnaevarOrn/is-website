<!doctype html>
<html lang="is">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GDELT — Global News Intelligence</title>
  <style>
    :root{
      --bg:#070a18; --card:#0f1430; --muted:#a9b3d1; --txt:#e8ecff;
      --line:rgba(255,255,255,.10); --good:#55f3a3; --bad:#ff5a7a; --mid:#ffd36b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--txt); }
    header{ padding:16px 14px; border-bottom:1px solid var(--line); position:sticky; top:0; background:rgba(7,10,24,.9); backdrop-filter: blur(10px); }
    h1{ margin:0; font-size:18px; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:12px; margin-top:6px; }
    .wrap{ max-width:980px; margin:0 auto; padding:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    input, select, button{
      background:var(--card); color:var(--txt); border:1px solid var(--line);
      padding:10px 10px; border-radius:12px; outline:none;
    }
    input{ min-width:260px; flex:1; }
    select{ min-width:150px; }
    button{ cursor:pointer; border-color:rgba(255,255,255,.18); }
    button:hover{ filter:brightness(1.08); }
    .pill{ display:inline-flex; gap:8px; align-items:center; border:1px solid var(--line); background:var(--card); padding:10px 12px; border-radius:14px; }
    .stats{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .k{ font-size:12px; color:var(--muted); }
    .v{ font-family:var(--mono); font-size:13px; }
    .bar{ height:10px; border-radius:999px; overflow:hidden; border:1px solid var(--line); background:rgba(255,255,255,.06); }
    .bar > div{ height:100%; width:50%; background:linear-gradient(90deg, var(--bad), var(--mid), var(--good)); }
    .grid{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top:14px; }
    .card{ border:1px solid var(--line); background:rgba(15,20,48,.75); border-radius:16px; padding:12px; }
    .top{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
    .title{ font-size:14px; margin:0 0 6px; line-height:1.25; }
    a{ color:inherit; text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .meta{ color:var(--muted); font-size:12px; display:flex; gap:10px; flex-wrap:wrap; }
    .badge{ font-family:var(--mono); font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--line); white-space:nowrap; }
    .toneGood{ border-color:rgba(85,243,163,.35); color:var(--good); }
    .toneBad{ border-color:rgba(255,90,122,.35); color:var(--bad); }
    .toneMid{ border-color:rgba(255,211,107,.35); color:var(--mid); }
    .err{ color:#ffd1d9; border:1px solid rgba(255,90,122,.3); background:rgba(255,90,122,.08); padding:12px; border-radius:14px; margin-top:12px; }
    .foot{ color:var(--muted); font-size:12px; margin:18px 0 10px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>GDELT — Global News Intelligence</h1>
      <div class="sub">Leit í alþjóðlegum fréttum + “tone” (sentiment) og einföld geopólitísk skönnun.</div>
    </div>
  </header>

  <main class="wrap">
    <div class="row">
      <div style="flex:2">
        <label>Leitarstrengur</label>
        <input id="q" placeholder='t.d. (iceland OR "reykjanes peninsula") AND volcano' />
      </div>

      <div>
        <label>Tímagluggi</label>
        <select id="recent">
          <option value="6h">6 klst</option>
          <option value="12h" selected>12 klst</option>
          <option value="24h">24 klst</option>
          <option value="3d">3 dagar</option>
          <option value="7d">7 dagar</option>
          <option value="30d">30 dagar</option>
        </select>
      </div>

      <div>
        <label>Fjöldi</label>
        <select id="max">
          <option>20</option>
          <option selected>50</option>
          <option>100</option>
          <option>200</option>
        </select>
      </div>

      <div>
        <label>Röðun</label>
        <select id="sort">
          <option value="DateDesc" selected>Nýjast</option>
          <option value="DateAsc">Elst</option>
          <option value="ToneDesc">Jákvæðast</option>
          <option value="ToneAsc">Neikvæðast</option>
        </select>
      </div>

      <div>
        <label>&nbsp;</label>
        <button id="go">Sækja</button>
      </div>
    </div>

    <div class="stats" id="stats" style="display:none;"></div>
    <div id="err"></div>
    <div class="grid" id="list"></div>

    <div class="foot">
      * “Tone” er mælikvarði frá GDELT (túlkaðu sem vísbendingu, ekki sannleika — heimsfréttir eru óreiðukennd vél). :contentReference[oaicite:5]{index=5}
    </div>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);

    function toneClass(t) {
      if (!Number.isFinite(t)) return "toneMid";
      if (t >= 2) return "toneGood";
      if (t <= -2) return "toneBad";
      return "toneMid";
    }

    function fmtTone(t) {
      if (!Number.isFinite(t)) return "tone: ?";
      const s = (Math.round(t * 10) / 10).toFixed(1);
      return `tone: ${s}`;
    }

    function parseDate(s) {
      // GDELT often returns seendate like 20260202113000 or ISO-ish variants depending on mode.
      if (!s) return "";
      if (/^\d{14}$/.test(s)) {
        const Y = s.slice(0,4), M = s.slice(4,6), D = s.slice(6,8);
        const h = s.slice(8,10), m = s.slice(10,12);
        return `${Y}-${M}-${D} ${h}:${m}`;
      }
      return String(s).slice(0, 19).replace("T"," ");
    }

    function esc(s) {
      return String(s || "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function statPill(k, v) {
      const el = document.createElement("div");
      el.className = "pill";
      el.innerHTML = `<div><div class="k">${esc(k)}</div><div class="v">${esc(v)}</div></div>`;
      return el;
    }

    function computeStats(arts) {
      let n = 0, sum = 0;
      const byCountry = new Map();

      for (const a of arts) {
        const t = Number(a.tone);
        if (Number.isFinite(t)) { sum += t; n++; }
        const c = a.sourceCountry || a.sourcecountry || "??";
        byCountry.set(c, (byCountry.get(c) || 0) + 1);
      }

      const avg = n ? (sum / n) : NaN;
      const top = [...byCountry.entries()].sort((x,y)=>y[1]-x[1]).slice(0,5);

      return { avg, nTone: n, top };
    }

    async function run() {
      $("err").innerHTML = "";
      $("list").innerHTML = "";
      $("stats").style.display = "none";
      $("stats").innerHTML = "";

      const q = $("q").value.trim();
      if (!q) {
        $("err").innerHTML = `<div class="err">Settu inn leitarstreng.</div>`;
        return;
      }

      const params = new URLSearchParams({
        q,
        recent: $("recent").value,
        max: $("max").value,
        sort: $("sort").value,
        mode: "ArtList",
        format: "json"
      });

      const r = await fetch(`/api/GDELT?${params.toString()}`);
      const j = await r.json();

      if (!j.ok) {
        $("err").innerHTML = `<div class="err">
          Villa frá proxy/upstream.<br/>
          <span style="font-family:var(--mono); font-size:12px;">${esc(j.error || "unknown error")}</span>
        </div>`;
        return;
      }

      const data = j.data || {};
      const arts = data.articles || data.articles || [];

      // Stats
      const st = computeStats(arts);
      const statsEl = $("stats");
      statsEl.style.display = "flex";
      statsEl.appendChild(statPill("Niðurstöður", String(arts.length)));
      statsEl.appendChild(statPill("Tone meðaltal", Number.isFinite(st.avg) ? st.avg.toFixed(2) : "—"));
      statsEl.appendChild(statPill("Tone sýnishorn", String(st.nTone)));

      if (st.top.length) {
        statsEl.appendChild(statPill("Top sourceCountry", st.top.map(([c,n])=>`${c}:${n}`).join("  ")));
      }

      // List
      const list = $("list");
      if (!arts.length) {
        list.innerHTML = `<div class="card">Engar niðurstöður. Prófaðu annan streng eða lengdu tímagluggann.</div>`;
        return;
      }

      for (const a of arts) {
        const title = a.title || a.seendate || "Untitled";
        const url = a.url || a.urlMobile || a.url_mobile || "";
        const src = a.sourceCountry || a.sourcecountry || "??";
        const lang = a.language || a.sourcelang || "??";
        const dt = parseDate(a.seendate || a.seenDate || a.datetime);

        const t = Number(a.tone);
        const badge = `<span class="badge ${toneClass(t)}">${esc(fmtTone(t))}</span>`;

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="top">
            <div style="min-width:0;">
              <div class="title">
                ${url ? `<a href="${esc(url)}" target="_blank" rel="noopener">${esc(title)}</a>` : esc(title)}
              </div>
              <div class="meta">
                <span>${esc(dt)}</span>
                <span>src: <span style="font-family:var(--mono)">${esc(src)}</span></span>
                <span>lang: <span style="font-family:var(--mono)">${esc(lang)}</span></span>
              </div>
            </div>
            <div>${badge}</div>
          </div>
        `;
        list.appendChild(card);
      }
    }

    $("go").addEventListener("click", run);
    $("q").addEventListener("keydown", (e) => {
      if (e.key === "Enter") run();
    });

    // Smá "default" fyrir fyrstu prófun
    $("q").value = '(iceland OR "reykjanes peninsula") AND (volcano OR eruption)';
  </script>
</body>
</html>
