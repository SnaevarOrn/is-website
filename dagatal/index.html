<!doctype html>
<html lang="is">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dagatal</title>
  <style>
    :root{
      --bg:#071a24;         /* einn bakgrunnslitur √° √∂llu */
      --panel:#0b2532;
      --panel2:#0e2c3b;
      --text:#e8f6ff;
      --muted:#9fc5da;
      --ice:#bfe9ff;
      --ring:#ff3b3b;
      --border: rgba(191,233,255,.16);
      --shadow: rgba(0,0,0,.35);
      --focus: rgba(103,199,255,.45);
      --cell:#0c2a39;
      --cellHover:#103244;
      --today:#ff3b3b;
      --today2: rgba(255,59,59,.18);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color:var(--text);
    }

    /* Header (sticky) */
    .topbar{
      position: sticky;
      top:0;
      z-index:20;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
    }
    .topbar-inner{
      max-width: 1100px;
      margin: 0 auto;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background: var(--panel);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn:hover{ background: var(--panel2); border-color: rgba(191,233,255,.28); }
    .btn:active{ transform: translateY(1px); }

    .title-wrap{
      position:relative;
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:center;
      flex: 1;
      min-width: 220px;
    }
    .year{
      font-size: 17px;
      letter-spacing:.5px;
      font-weight: 900;
      color: var(--ice);
      min-width: 70px;
      text-align:center;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(191,233,255,.14);
      background: var(--panel);
      cursor:pointer;
      user-select:none;
    }
    .year:hover{ border-color: rgba(191,233,255,.30); background: var(--panel2); }

    /* Gear bigger */
    #settingsBtn .gear{
      font-size: 24px;
      line-height: 1;
      display:inline-block;
      transform: translateY(1px);
    }

    /* Year dropdown */
    .year-pop{
      position:absolute;
      top: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      width: min(340px, 92vw);
      border-radius: 14px;
      border:1px solid rgba(191,233,255,.18);
      background: var(--panel);
      box-shadow: 0 22px 50px rgba(0,0,0,.45);
      padding: 12px;
      display:none;
      z-index:50;
    }
    .year-pop.show{ display:block; }
    .row{ display:flex; gap:10px; align-items:center; }
    .row + .row{ margin-top:10px; }

    .year-pop input{
      flex:1;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(191,233,255,.14);
      background: var(--bg);
      color: var(--text);
      outline:none;
      font-size: 16px;
    }
    .year-pop input:focus{ border-color: rgba(103,199,255,.55); box-shadow: 0 0 0 3px rgba(103,199,255,.10); }

    .chip{
      appearance:none;
      border:1px solid rgba(191,233,255,.14);
      background: var(--bg);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:800;
    }
    .chip:hover{ border-color: rgba(191,233,255,.28); background: var(--panel2); }

    /* Sticky sub-header: month label + weekdays (frozen) */
    .subbar{
      border-top: 1px solid rgba(191,233,255,.08);
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    .subbar-inner{
      max-width: 1100px;
      margin: 0 auto;
      padding: 10px 14px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .subrow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sub-title{
      font-weight: 900;
      color: var(--ice);
      letter-spacing:.4px;
      font-size: 14px;
      padding: 10px 12px;
      border:1px solid rgba(191,233,255,.14);
      background: var(--panel);
      border-radius: 12px;
      min-width: 140px;
      text-transform: lowercase;
    }
    .sub-meta{
      color: var(--muted);
      font-size: 13px;
      white-space:nowrap;
      opacity:.95;
    }

    .dowbar{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
      color: var(--muted);
      font-size: 12px;
      text-transform: lowercase;
    }
    .dowbar div{
      height: 42px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 12px;
      background: var(--bg);
      border: 1px solid rgba(191,233,255,.10);
    }

    /* Settings */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display:none;
      z-index: 30;
    }
    .overlay.show{ display:block; }

    .sheet{
      position: fixed;
      left: 50%;
      top: 86px;
      transform: translateX(-50%);
      width: min(520px, 92vw);
      border-radius: 16px;
      border:1px solid rgba(191,233,255,.18);
      background: var(--panel);
      box-shadow: 0 30px 70px rgba(0,0,0,.55);
      display:none;
      z-index: 40;
      overflow:hidden;
    }
    .sheet.show{ display:block; }

    .sheet-header{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
      background: var(--panel);
    }
    .sheet-title{
      font-weight: 900;
      letter-spacing:.4px;
      color: var(--ice);
    }
    .sheet-body{
      padding: 12px 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .group{
      border:1px solid rgba(191,233,255,.12);
      border-radius: 14px;
      background: var(--bg);
      padding: 10px 12px;
    }
    .group h4{
      margin:0 0 10px 0;
      font-size: 12px;
      letter-spacing:.35px;
      text-transform: uppercase;
      color: var(--muted);
    }

    .toggle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 8px;
      border-radius: 12px;
    }
    .toggle label{
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      font-size: 14px;
    }
    .toggle input{
      width: 18px;
      height: 18px;
      accent-color: var(--ice);
      cursor:pointer;
    }

    .seg{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .seg button{
      border:1px solid rgba(191,233,255,.14);
      background: var(--panel);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .seg button.active{
      border-color: rgba(103,199,255,.55);
      box-shadow: 0 0 0 3px rgba(103,199,255,.10);
    }
    .seg button:hover{ background: var(--panel2); }

    .linkbtn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid rgba(191,233,255,.14);
      background: var(--panel);
      cursor:pointer;
      font-weight: 900;
    }
    .linkbtn:hover{ background: var(--panel2); border-color: rgba(191,233,255,.28); }

    /* Main */
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 12px 14px 34px;
    }

    .month{
      border:1px solid var(--border);
      background: var(--panel);
      border-radius: 16px;
      margin: 14px 0;
      overflow:hidden;
    }
    .month-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      border-bottom:1px solid var(--border);
      background: var(--panel);
    }
    .month-name{ font-weight: 900; color: var(--ice); letter-spacing:.4px; }
    .month-meta{ color: var(--muted); font-size: 13px; }

    .grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
      padding: 12px;
    }

    .cell{
      position:relative;
      height: 42px;
      border-radius: 12px;
      border: 1px solid rgba(191,233,255,.14);
      background: var(--cell);
      display:flex;
      align-items:center;
      justify-content:center;
      transition: background .15s ease, border-color .15s ease, transform .08s ease;
      overflow:hidden;
    }
    .cell:hover{
      background: var(--cellHover);
      border-color: rgba(191,233,255,.28);
    }
    .cell.is-empty{
      background: transparent;
      border: 1px dashed rgba(191,233,255,.12);
      opacity:.25;
    }
    .dnum{ font-size: 16px; font-weight: 900; }

    .cell.is-holiday::after{
      content:"";
      position:absolute;
      inset: 6px;
      border-radius: 10px;
      border: 2px solid var(--ring);
      pointer-events:none;
      opacity: .95;
    }

    .moon{
      position:absolute;
      top: 6px;
      right: 8px;
      font-size: 14px;
      opacity: .95;
    }

    /* Today: full red + shimmer */
    .cell.is-today{
      background: var(--today);
      border-color: rgba(255,255,255,.35);
      color: #06131c;
    }
    .cell.is-today .dnum{ color:#06131c; }
    .cell.is-today::before{
      content:"";
      position:absolute;
      inset:-40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
      transform: rotate(18deg) translateX(-120%);
      animation: shimmer 2.6s ease-in-out infinite;
      opacity:.9;
      pointer-events:none;
    }
    @keyframes shimmer{
      0%{ transform: rotate(18deg) translateX(-120%); opacity:.0; }
      20%{ opacity:.55; }
      50%{ opacity:.35; }
      100%{ transform: rotate(18deg) translateX(120%); opacity:.0; }
    }

    /* Weeks view */
    .weeks{
      border:1px solid var(--border);
      border-radius: 16px;
      overflow:hidden;
      background: var(--panel);
      margin: 14px 0;
    }
    .weeks-header{
      padding: 12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      background: var(--panel);
    }
    .weeks-title{ font-weight: 900; color: var(--ice); }
    .weeks-meta{ color: var(--muted); font-size: 13px; }

    /* Frozen weekday header for weeks is in the global header (subbar),
       but we keep a subtle spacer row inside weeks to align visually */
    .weeks-dow-spacer{
      padding: 10px 12px 0;
    }

    .week-row{
      display:grid;
      grid-template-columns: 72px 1fr;
      gap:10px;
      padding: 10px 12px;
      border-top:1px solid rgba(191,233,255,.10);
      align-items:center;
    }
    .week-row:first-of-type{ border-top:none; }
    .wn{
      font-weight: 900;
      color: var(--muted);
      background: var(--bg);
      border:1px solid rgba(191,233,255,.10);
      border-radius: 12px;
      height: 42px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .week-grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
    }

    /* Holidays list view */
    .holidays{
      border:1px solid var(--border);
      background: var(--panel);
      border-radius: 16px;
      overflow:hidden;
      margin: 14px 0;
    }
    .holidays-header{
      padding: 12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .holidays-title{ font-weight: 900; color: var(--ice); }
    .hitem{
      padding: 12px 14px;
      border-top:1px solid rgba(191,233,255,.10);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
    }
    .hitem:first-of-type{ border-top:none; }
    .hleft{
      font-weight: 900;
      letter-spacing:.2px;
    }
    .hright{
      color: var(--muted);
      font-size: 13px;
      white-space:nowrap;
    }

    .footer{ margin-top: 18px; color: rgba(159,197,218,.85); font-size: 12px; text-align:center; }

    @media (max-width: 520px){
      .topbar-inner{ padding: 11px 12px; }
      .subbar-inner{ padding: 9px 12px 11px; }
      .wrap{ padding: 10px 12px 26px; }
      .cell{ height: 42px; }
      .week-row{ grid-template-columns: 62px 1fr; }
      .wn{ height: 42px; }
      .sheet{ top: 78px; }
      .sub-title{ min-width: 120px; }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <button class="btn" id="backBtn" title="Til baka">‚Üê <span style="opacity:.9">Til baka</span></button>

      <div class="title-wrap" id="titleWrap">
        <button class="btn" id="prevYear" title="Fyrra √°r">‚Äπ</button>
        <div class="year" id="yearLabel" title="Velja √°r">2025</div>
        <button class="btn" id="nextYear" title="N√¶sta √°r">‚Ä∫</button>

        <div class="year-pop" id="yearPop" aria-hidden="true">
          <div class="row">
            <input id="yearInput" type="number" inputmode="numeric" />
            <button class="btn" id="goYearBtn">Fara</button>
          </div>
          <div class="row" style="justify-content:space-between;">
            <button class="chip" data-jump="-50">-50</button>
            <button class="chip" data-jump="-10">-10</button>
            <button class="chip" data-jump="10">+10</button>
            <button class="chip" data-jump="50">+50</button>
          </div>
        </div>
      </div>

      <button class="btn" id="settingsBtn" title="Stillingar"><span class="gear">‚öôÔ∏é</span></button>
    </div>

    <!-- Frozen month + weekdays -->
    <div class="subbar">
      <div class="subbar-inner">
        <div class="subrow">
          <div class="sub-title" id="monthLabel">jan√∫ar</div>
          <div class="sub-meta" id="subMeta">2025</div>
        </div>
        <div class="dowbar" id="dowBar">
          <div>m√°n</div><div>√æri</div><div>mi√∞</div><div>fim</div><div>f√∂s</div><div>lau</div><div>sun</div>
        </div>
      </div>
    </div>
  </header>

  <!-- Settings overlay/sheet -->
  <div class="overlay" id="overlay"></div>
  <aside class="sheet" id="sheet" role="dialog" aria-modal="true" aria-label="Stillingar">
    <div class="sheet-header">
      <div class="sheet-title">Stillingar</div>
      <button class="btn" id="closeSheet" title="Loka">‚úï</button>
    </div>
    <div class="sheet-body">

      <div class="group">
        <h4>S√Ωn</h4>
        <div class="seg" id="layoutSeg">
          <button data-layout="months" class="active">M√°nu√∞ir</button>
          <button data-layout="weeks">Vikur</button>
        </div>
      </div>

      <div class="group">
        <h4>Merkingar</h4>
        <div class="toggle">
          <label><input type="checkbox" id="toggleHolidays" /> L√∂gbundnir fr√≠dagar</label>
        </div>
        <div class="toggle">
          <label><input type="checkbox" id="toggleMoon" /> Tungl (üåï / üåë)</label>
        </div>
      </div>

      <div class="group">
        <h4>Fl√Ωtilei√∞ir</h4>
        <button class="linkbtn" id="todayBtn">
          <span>√ç dag</span>
          <span style="opacity:.85">‚§í</span>
        </button>
        <button class="linkbtn" id="showHolidaysBtn">
          <span>Sko√∞a fr√≠daga</span>
          <span style="opacity:.85">‚Ä∫</span>
        </button>
      </div>

    </div>
  </aside>

  <main class="wrap">
    <div id="calendar"></div>
    <div class="footer">√≠s.is ‚Äî dagatal prot√≥t√Ωpa</div>
  </main>

<script>
(() => {
  const pad2 = (n) => String(n).padStart(2, "0");
  const isoDate = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const WEEKDAYS = ["m√°n","√æri","mi√∞","fim","f√∂s","lau","sun"]; // Monday-first
  const MONTHS_LONG = ["jan√∫ar","febr√∫ar","mars","apr√≠l","ma√≠","j√∫n√≠","j√∫l√≠","√°g√∫st","september","okt√≥ber","n√≥vember","desember"];
  const monIndex = (jsDay) => (jsDay + 6) % 7;
  const isLeapYear = (y) => (y % 4 === 0 && y % 100 !== 0) || (y % 400 === 0);
  const daysInMonth = (y, m) => new Date(y, m+1, 0).getDate();

  // ISO week number (Monday-first)
  function isoWeekNumber(date){
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7; // Mon=1..Sun=7
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }

  // Easter (Meeus/Jones/Butcher)
  function easterSunday(year){
    const a = year % 19;
    const b = Math.floor(year / 100);
    const c = year % 100;
    const d = Math.floor(b / 4);
    const e = b % 4;
    const f = Math.floor((b + 8) / 25);
    const g = Math.floor((b - f + 1) / 3);
    const h = (19*a + b - d - g + 15) % 30;
    const i = Math.floor(c / 4);
    const k = c % 4;
    const l = (32 + 2*e + 2*i - h - k) % 7;
    const m = Math.floor((a + 11*h + 22*l) / 451);
    const month = Math.floor((h + l - 7*m + 114) / 31);
    const day = ((h + l - 7*m + 114) % 31) + 1;
    return new Date(year, month-1, day);
  }
  function addDays(date, n){ const d = new Date(date); d.setDate(d.getDate() + n); return d; }

  function firstThursdayAfterApril18(year){
    const start = new Date(year, 3, 19);
    const delta = (3 - monIndex(start.getDay()) + 7) % 7; // Thursday=3
    return addDays(start, delta);
  }
  function firstMondayOfAugust(year){
    const d = new Date(year, 7, 1);
    const delta = (0 - monIndex(d.getDay()) + 7) % 7; // Monday=0
    return addDays(d, delta);
  }

  // Holiday names + set
  function getIcelandHolidayMap(year){
    const map = new Map(); // iso -> name
    const add = (m,d,name) => map.set(`${year}-${pad2(m)}-${pad2(d)}`, name);

    add(1,1,"N√Ω√°rsdagur");
    add(1,6,"√ûrett√°ndinn");
    add(5,1,"Verkal√Ω√∞sdagurinn");
    add(6,17,"√ûj√≥√∞h√°t√≠√∞ardagurinn");
    add(12,24,"A√∞fangadagur");
    add(12,25,"J√≥ladagur");
    add(12,26,"Annar √≠ j√≥lum");
    add(12,31,"Gaml√°rsdagur");

    const easter = easterSunday(year);
    map.set(isoDate(addDays(easter,-3)), "Sk√≠rdagur");
    map.set(isoDate(addDays(easter,-2)), "F√∂studagurinn langi");
    map.set(isoDate(easter), "P√°skadagur");
    map.set(isoDate(addDays(easter,1)), "Annar √≠ p√°skum");
    map.set(isoDate(addDays(easter,39)), "Uppstigningardagur");
    map.set(isoDate(addDays(easter,49)), "Hv√≠tasunnudagur");
    map.set(isoDate(addDays(easter,50)), "Annar √≠ hv√≠tasunnu");

    map.set(isoDate(firstThursdayAfterApril18(year)), "Sumardagurinn fyrsti");
    map.set(isoDate(firstMondayOfAugust(year)), "Fr√≠dagur verslunarmanna");

    return map;
  }

  // Moon phases: local minima -> no doubles
  const SYNODIC = 29.530588853;
  const REF_NEW = Date.UTC(2000,0,6,18,14,0);
  function moonAgeDays(date){
    const t = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate(), 12, 0, 0);
    const daysSince = (t - REF_NEW) / 86400000;
    const age = ((daysSince % SYNODIC) + SYNODIC) % SYNODIC;
    return age;
  }
  function phaseDistance(age, target){ return Math.abs(age - target); }
  function computeMoonMarkersForYear(year){
    const markers = new Map(); // iso -> "new" | "full"
    const dates = [];
    const start = new Date(year,0,1);
    const end = new Date(year,11,31);
    for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) dates.push(new Date(d));

    const fullT = SYNODIC/2;
    const eps = 1.0;

    for (let i=1; i<dates.length-1; i++){
      const d = dates[i], prev = dates[i-1], next = dates[i+1];
      const a  = moonAgeDays(d), ap = moonAgeDays(prev), an = moonAgeDays(next);

      const dn  = Math.min(a, SYNODIC - a);
      const dnp = Math.min(ap, SYNODIC - ap);
      const dnn = Math.min(an, SYNODIC - an);
      if (dn < dnp && dn < dnn && dn <= eps) markers.set(isoDate(d), "new");

      const df  = phaseDistance(a, fullT);
      const dfp = phaseDistance(ap, fullT);
      const dfn = phaseDistance(an, fullT);
      if (df < dfp && df < dfn && df <= eps) markers.set(isoDate(d), "full");
    }
    return markers;
  }

  const $ = (sel) => document.querySelector(sel);
  const calendarEl = $("#calendar");
  const yearLabel = $("#yearLabel");
  const monthLabel = $("#monthLabel");
  const subMeta = $("#subMeta");

  const state = {
    year: 2025,
    showHolidays: false, // default: ekkert haka√∞
    showMoon: false,     // default: ekkert haka√∞
    layout: "months",    // "months" | "weeks"
    view: "calendar",    // "calendar" | "holidays"
    holidayMap: new Map(),
    moonMarkers: new Map(),
    monthObserver: null,
  };

  function weekdayShort(date){ return WEEKDAYS[monIndex(date.getDay())]; }
  function monthShort(m){ return ["jan","feb","mar","apr","ma√≠","j√∫n","j√∫l","√°g√∫","sep","okt","n√≥v","des"][m]; }

  function setHeaderContext(){
    // Month label depends on view/layout
    if (state.view === "holidays"){
      monthLabel.textContent = "fr√≠dagar";
      subMeta.textContent = String(state.year);
      return;
    }
    if (state.layout === "weeks"){
      monthLabel.textContent = "vikur";
      subMeta.textContent = String(state.year);
      return;
    }
    // months layout: month label is dynamic via observer, but ensure year is shown
    subMeta.textContent = String(state.year);
  }

  function disconnectMonthObserver(){
    if (state.monthObserver){
      state.monthObserver.disconnect();
      state.monthObserver = null;
    }
  }

  function setupMonthObserver(){
    disconnectMonthObserver();
    if (state.view !== "calendar" || state.layout !== "months") return;

    const monthSections = Array.from(document.querySelectorAll(".month[data-month]"));
    if (!monthSections.length) return;

    // Set initial label to first month
    const firstM = parseInt(monthSections[0].dataset.month, 10);
    if (Number.isFinite(firstM)) monthLabel.textContent = MONTHS_LONG[firstM];

    const obs = new IntersectionObserver((entries) => {
      // pick the entry closest to top (highest intersection ratio + isIntersecting)
      const visible = entries.filter(e => e.isIntersecting);
      if (!visible.length) return;

      visible.sort((a,b) => (b.intersectionRatio - a.intersectionRatio));
      const m = parseInt(visible[0].target.dataset.month, 10);
      if (Number.isFinite(m)) monthLabel.textContent = MONTHS_LONG[m];
    }, {
      root: null,
      // This makes ‚Äúcurrent‚Äù month switch around mid-screen
      rootMargin: "-45% 0px -50% 0px",
      threshold: [0.01, 0.1, 0.25, 0.5]
    });

    monthSections.forEach(sec => obs.observe(sec));
    state.monthObserver = obs;
  }

  function build(){
    yearLabel.textContent = state.year;
    $("#yearInput").value = state.year;

    // ensure UI toggles match state
    $("#toggleHolidays").checked = state.showHolidays;
    $("#toggleMoon").checked = state.showMoon;

    state.holidayMap = getIcelandHolidayMap(state.year);
    state.moonMarkers = computeMoonMarkersForYear(state.year);

    calendarEl.innerHTML = "";
    disconnectMonthObserver();
    setHeaderContext();

    if (state.view === "holidays"){
      renderHolidayList();
      return;
    }
    if (state.layout === "weeks"){
      renderWeeks();
      return;
    }
    renderMonths();
    setupMonthObserver();
  }

  function makeDayCell(date){
    const iso = isoDate(date);
    const cell = document.createElement("div");
    cell.className = "cell";
    cell.dataset.iso = iso;

    const dnum = document.createElement("div");
    dnum.className = "dnum";
    dnum.textContent = date.getDate();
    cell.appendChild(dnum);

    if (state.showHolidays && state.holidayMap.has(iso)) cell.classList.add("is-holiday");

    if (state.showMoon){
      const mk = state.moonMarkers.get(iso);
      if (mk){
        const moon = document.createElement("div");
        moon.className = "moon";
        moon.textContent = (mk === "full") ? "üåï" : "üåë";
        cell.appendChild(moon);
      }
    }

    const today = new Date();
    if (iso === isoDate(today) && state.year === today.getFullYear()) cell.classList.add("is-today");

    return cell;
  }

  function renderMonths(){
    for (let m = 0; m < 12; m++){
      const monthBlock = document.createElement("section");
      monthBlock.className = "month";
      monthBlock.dataset.month = String(m);

      const mh = document.createElement("div");
      mh.className = "month-header";
      mh.innerHTML = `
        <div class="month-name">${MONTHS_LONG[m]}</div>
        <div class="month-meta">${state.year} ‚Äî ${daysInMonth(state.year, m)} dagar${(m===1 && isLeapYear(state.year)) ? " (hlaup√°r)" : ""}</div>
      `;
      monthBlock.appendChild(mh);

      // NOTE: vikudagar eru n√∫ frystir √≠ header (√≥√æarfi √≠ hverjum m√°nu√∞i)

      const grid = document.createElement("div");
      grid.className = "grid";

      const first = new Date(state.year, m, 1);
      const offset = monIndex(first.getDay());
      for (let i=0; i<offset; i++){
        const empty = document.createElement("div");
        empty.className = "cell is-empty";
        grid.appendChild(empty);
      }

      const dim = daysInMonth(state.year, m);
      for (let day=1; day<=dim; day++){
        grid.appendChild(makeDayCell(new Date(state.year, m, day)));
      }

      monthBlock.appendChild(grid);
      calendarEl.appendChild(monthBlock);
    }
  }

  function renderWeeks(){
    const box = document.createElement("section");
    box.className = "weeks";

    const wh = document.createElement("div");
    wh.className = "weeks-header";
    wh.innerHTML = `
      <div class="weeks-title">Vikur</div>
      <div class="weeks-meta">${state.year}</div>
    `;
    box.appendChild(wh);

    // Small spacer so it doesn't feel glued (weekday header is frozen globally)
    const spacer = document.createElement("div");
    spacer.className = "weeks-dow-spacer";
    spacer.innerHTML = `<div style="height:1px;opacity:.0"></div>`;
    box.appendChild(spacer);

    // Find first Monday that starts the first ISO week covering the year
    let d = new Date(state.year, 0, 1);
    const jan4 = new Date(state.year,0,4);
    const jan4MonOffset = monIndex(jan4.getDay()); // 0..6
    d = new Date(jan4);
    d.setDate(d.getDate() - jan4MonOffset);

    const end = new Date(state.year,11,31);

    while (d <= end){
      const row = document.createElement("div");
      row.className = "week-row";

      const wn = document.createElement("div");
      wn.className = "wn";
      wn.textContent = "V" + isoWeekNumber(d);
      row.appendChild(wn);

      const wg = document.createElement("div");
      wg.className = "week-grid";

      for (let i=0; i<7; i++){
        const day = new Date(d);
        day.setDate(d.getDate() + i);

        if (day.getFullYear() !== state.year){
          const empty = document.createElement("div");
          empty.className = "cell is-empty";
          wg.appendChild(empty);
        } else {
          wg.appendChild(makeDayCell(day));
        }
      }

      row.appendChild(wg);
      box.appendChild(row);

      d.setDate(d.getDate() + 7);
    }

    calendarEl.appendChild(box);
  }

  function renderHolidayList(){
    const box = document.createElement("section");
    box.className = "holidays";

    const hh = document.createElement("div");
    hh.className = "holidays-header";
    hh.innerHTML = `
      <div class="holidays-title">Fr√≠dagar</div>
      <div class="month-meta">${state.year}</div>
    `;
    box.appendChild(hh);

    const items = Array.from(state.holidayMap.entries())
      .sort((a,b) => a[0].localeCompare(b[0]));

    for (const [iso, name] of items){
      const [y,mm,dd] = iso.split("-").map(Number);
      const date = new Date(y, mm-1, dd);
      const right = `${dd} ${monthShort(mm-1)} ‚Äî ${weekdayShort(date)}`;

      const item = document.createElement("div");
      item.className = "hitem";
      item.innerHTML = `<div class="hleft">${name}</div><div class="hright">${right}</div>`;
      box.appendChild(item);
    }

    calendarEl.appendChild(box);
  }

  function jumpToToday(){
    const now = new Date();
    state.year = now.getFullYear();
    state.view = "calendar";
    build();

    const iso = isoDate(now);
    const el = document.querySelector(`[data-iso="${iso}"]`);
    if (el){
      el.scrollIntoView({ behavior:"smooth", block:"center" });
    }
  }

  // Year dropdown
  const pop = $("#yearPop");
  const titleWrap = $("#titleWrap");
  function togglePop(force){
    const show = (typeof force === "boolean") ? force : !pop.classList.contains("show");
    pop.classList.toggle("show", show);
    pop.setAttribute("aria-hidden", String(!show));
    if (show) $("#yearInput").focus();
  }
  document.addEventListener("click", (e) => {
    if (!pop.classList.contains("show")) return;
    if (!titleWrap.contains(e.target)) togglePop(false);
  });
  yearLabel.addEventListener("click", () => togglePop());
  $("#goYearBtn").addEventListener("click", () => {
    const v = parseInt($("#yearInput").value, 10);
    if (Number.isFinite(v)) { state.year = v; state.view="calendar"; build(); }
    togglePop(false);
  });
  $("#yearInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") $("#goYearBtn").click();
    if (e.key === "Escape") togglePop(false);
  });
  pop.querySelectorAll("[data-jump]").forEach(btn => {
    btn.addEventListener("click", () => {
      const j = parseInt(btn.getAttribute("data-jump"), 10);
      state.year += j;
      state.view="calendar";
      build();
    });
  });

  // Settings sheet
  const overlay = $("#overlay");
  const sheet = $("#sheet");
  function openSheet(){
    overlay.classList.add("show");
    sheet.classList.add("show");
  }
  function closeSheet(){
    overlay.classList.remove("show");
    sheet.classList.remove("show");
  }
  $("#settingsBtn").addEventListener("click", openSheet);
  $("#closeSheet").addEventListener("click", closeSheet);
  overlay.addEventListener("click", closeSheet);
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") { togglePop(false); closeSheet(); }
  });

  // Layout segmented control
  $("#layoutSeg").querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      $("#layoutSeg").querySelectorAll("button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      state.layout = btn.dataset.layout;
      state.view = "calendar";
      build();
    });
  });

  // Toggles (default unchecked)
  $("#toggleHolidays").addEventListener("change", (e) => { state.showHolidays = e.target.checked; build(); });
  $("#toggleMoon").addEventListener("change", (e) => { state.showMoon = e.target.checked; build(); });

  // Holidays view
  $("#showHolidaysBtn").addEventListener("click", () => {
    state.view = "holidays";
    build();
    closeSheet();
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // Today button (in settings)
  $("#todayBtn").addEventListener("click", () => {
    closeSheet();
    jumpToToday();
  });

  // Header nav
  $("#backBtn").addEventListener("click", () => history.back());

  // If user is viewing holidays, arrow navigation should exit holidays and return to calendar
  function bumpYear(delta){
    state.year += delta;
    if (state.view === "holidays") state.view = "calendar";
    build();
  }
  $("#prevYear").addEventListener("click", () => bumpYear(-1));
  $("#nextYear").addEventListener("click", () => bumpYear(1));

  // Init
  build();
})();
</script>
</body>
</html>