<!doctype html>
<html lang="is">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sólkerfi — Horizons (plánetur + sporbaugar + tunglfasi)</title>
  <style>
    :root{
      --bg:#070a18;
      --stroke:rgba(255,255,255,.14);
      --text:#eaf0ff;
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.55);
      --bad:rgba(251,113,133,.35);
      --good:rgba(74,222,128,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --shadow: 0 14px 46px rgba(0,0,0,.42);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(167,139,250,.28), transparent 55%),
        radial-gradient(900px 520px at 80% 15%, rgba(34,211,238,.18), transparent 55%),
        radial-gradient(900px 720px at 50% 92%, rgba(251,191,36,.10), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1050px; margin:0 auto; padding:18px; display:grid; gap:12px;}
    .card{
      border:1px solid var(--stroke);
      border-radius:16px;
      overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
    }
    .hd{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .title{font-size:12px; letter-spacing:.35px; text-transform:uppercase; color:var(--muted);}
    .status{font-family:var(--mono); font-size:12px; color:var(--muted2);}
    .bd{padding:14px; display:grid; gap:10px;}
    canvas{
      width:100%;
      height:560px;
      display:block;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:
        radial-gradient(700px 340px at 50% 45%, rgba(255,255,255,.06), transparent 60%),
        rgba(0,0,0,.18);
    }
    @media (max-width: 760px){ canvas{height:520px} }

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .chip{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .mono{font-family:var(--mono)}
    .controls{
      display:grid;
      gap:10px;
      padding-top:4px;
    }
    .panel{
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px;
      display:grid;
      gap:10px;
    }
    .subrow{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .toggles{display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
    label{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    input[type="checkbox"]{transform:translateY(1px)}
    input[type="range"]{width:min(520px, 100%);}

    .help{
      display:inline-flex; align-items:center; justify-content:center;
      width:18px; height:18px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      color:var(--muted2);
      font-size:12px;
      cursor:help;
      position:relative;
      flex:0 0 auto;
    }
    .help:hover::after{
      content:attr(data-tip);
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:calc(100% + 10px);
      width:min(420px, 80vw);
      white-space:normal;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.75);
      color:rgba(255,255,255,.86);
      font-size:12px;
      line-height:1.35;
      box-shadow:var(--shadow);
      z-index:10;
    }
    .help:hover::before{
      content:"";
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:calc(100% + 2px);
      border:8px solid transparent;
      border-top-color:rgba(255,255,255,.16);
    }

    .err{
      display:none;
      border:1px solid var(--bad);
      background:rgba(251,113,133,.08);
      border-radius:14px;
      padding:12px;
    }
    .oknote{
      border:1px solid var(--good);
      background:rgba(74,222,128,.08);
      border-radius:14px;
      padding:10px 12px;
      color:rgba(255,255,255,.80);
      font-size:12px;
      display:none;
    }
    .err pre{
      white-space:pre-wrap;
      word-break:break-word;
      font-size:12px;
      margin:8px 0 0;
      color:rgba(255,255,255,.75);
    }
    .small{font-size:12px; color:var(--muted2); line-height:1.35}
    button{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      font-weight:650;
      cursor:pointer;
    }
    button:hover{background:rgba(255,255,255,.09)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="hd">
      <div class="title">Sólkerfi (Horizons) — plánetur + sporbaugar + tunglfasi</div>
      <div id="status" class="status mono">sæki…</div>
    </div>
    <div class="bd">
      <div class="err" id="err"><b>Villa</b><pre id="errtxt"></pre></div>
      <div class="oknote" id="oknote"></div>

      <div class="row">
        <span class="chip">Dagur: <b id="day">—</b></span>

        <span class="chip">
          Illum: <b id="illum">—</b> <span id="phase" style="opacity:.85"></span>
          <span class="help" title="Hjálp" data-tip="Illum = lýst hlutfall tunglsins (0% = nýtt, 50% = hálft, 100% = fullt). Reiknað úr horninu α milli vektoranna (Moon→Sun) og (Moon→Earth):  illum = (1 − cos(α)) / 2.">?</span>
        </span>

        <span class="chip">d(E→M): <b id="distAU">—</b> <span class="mono" style="opacity:.7">AU</span></span>
        <span class="chip">≈ <b id="distKM">—</b> <span class="mono" style="opacity:.7">km</span></span>

        <span class="chip">
          Gögn: <span class="mono">x,y</span> í <span class="mono">AU</span>, plan = <span class="mono">ecliptic</span>
          <span class="help" data-tip="Ephemeris: heliocentric staða plánetu (Sun-centered). Moon: geocentric staða tungls (Earth-centered). Allt er 2D (x,y) í ecliptic plani í þessari V1.">?</span>
        </span>
      </div>

      <canvas id="cv"></canvas>

      <div class="controls panel">
        <div class="subrow">
          <div class="toggles">
            <label><input type="checkbox" id="showOrbits" checked> Sporbaugar</label>
            <label><input type="checkbox" id="showMoon" checked> Tungl</label>
            <label><input type="checkbox" id="showMoonTrue" checked> Tungl (raunstaða á helio)</label>
            <label><input type="checkbox" id="showPhaseDiagram" checked> Fasa-skýring</label>
          </div>
          <div class="toggles">
            <button id="today">Í dag</button>
            <button id="prev">Dagur −1</button>
            <button id="next">Dagur +1</button>
            <button id="reload">Sækja aftur</button>
          </div>
        </div>

        <div class="subrow">
          <label>
            Horizon window (days):
            <input type="range" id="days" min="1" max="365" value="30" />
            <span class="mono" id="daysLabel">30</span>
            <span class="help" data-tip="Sporbaugar eru teiknaðir út frá þessum glugga (days). Stærri gluggi = lengri slóð, en meiri líkur á 503 ef Horizons er í stuði. KV cache + stale-on-error hjálpar hér.">?</span>
          </label>

          <label>
            Timeline:
            <input type="range" id="t" min="0" max="29" value="0" />
            <span class="mono" id="tLabel">0</span>
          </label>
        </div>

        <div class="subrow">
          <div class="toggles">
            <span class="small">Veldu plánetur:</span>
            <label><input type="checkbox" class="body" value="mercury"> Merkúr</label>
            <label><input type="checkbox" class="body" value="venus"> Venus</label>
            <label><input type="checkbox" class="body" value="earth" checked> Jörð</label>
            <label><input type="checkbox" class="body" value="mars" checked> Mars</label>
            <label><input type="checkbox" class="body" value="jupiter"> Júpíter</label>
            <label><input type="checkbox" class="body" value="saturn"> Satúrnus</label>
          </div>
        </div>

        <div class="small">
          Við lesum: <span class="mono">PlanetHelio(x,y)</span> (sólmiðja) og <span class="mono">MoonGeo(x,y)</span> (jörðmiðja).
          Síðan: <span class="mono">MoonHelio = EarthHelio + MoonGeo</span>.
          <br/>Mælieining: <span class="mono">1 AU ≈ 149,597,870.7 km</span>.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const AU_KM = 149597870.7;

  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d");

  const el = {
    status: document.getElementById("status"),
    err: document.getElementById("err"),
    errtxt: document.getElementById("errtxt"),
    oknote: document.getElementById("oknote"),

    day: document.getElementById("day"),
    illum: document.getElementById("illum"),
    phase: document.getElementById("phase"),
    distAU: document.getElementById("distAU"),
    distKM: document.getElementById("distKM"),

    showOrbits: document.getElementById("showOrbits"),
    showMoon: document.getElementById("showMoon"),
    showMoonTrue: document.getElementById("showMoonTrue"),
    showPhaseDiagram: document.getElementById("showPhaseDiagram"),

    days: document.getElementById("days"),
    daysLabel: document.getElementById("daysLabel"),
    t: document.getElementById("t"),
    tLabel: document.getElementById("tLabel"),

    today: document.getElementById("today"),
    prev: document.getElementById("prev"),
    next: document.getElementById("next"),
    reload: document.getElementById("reload"),
  };

  function resize(){
    const r = cv.getBoundingClientRect();
    const dpr = Math.max(1, devicePixelRatio || 1);
    cv.width  = Math.floor(r.width * dpr);
    cv.height = Math.floor(r.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener("resize", resize); resize();

  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  const lerp = (a,b,t)=>a+(b-a)*t;

  const vAdd = (a,b)=>({x:a.x+b.x, y:a.y+b.y});
  const vSub = (a,b)=>({x:a.x-b.x, y:a.y-b.y});
  const vMul = (a,s)=>({x:a.x*s, y:a.y*s});
  const vLen = (a)=>Math.hypot(a.x,a.y);
  const vNorm = (a)=>{ const L=vLen(a)||1; return {x:a.x/L,y:a.y/L}; };
  const vDot = (a,b)=>a.x*b.x + a.y*b.y;
  const vAngle = (a,b)=>Math.acos(clamp(vDot(vNorm(a),vNorm(b)),-1,1));

  function phaseName(illum){
    if (illum < 0.05) return "— Nýtt";
    if (illum < 0.45) return "— Sigð";
    if (illum < 0.55) return "— Hálft (kvartil-ish)";
    if (illum < 0.95) return "— Gibbous";
    return "— Fullt";
  }

  function isoToday(){
    return new Date().toISOString().slice(0,10);
  }

  function roundRect(x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y, x+w,y+h, rr);
    ctx.arcTo(x+w,y+h, x,y+h, rr);
    ctx.arcTo(x,y+h, x,y, rr);
    ctx.arcTo(x,y, x+w,y, rr);
    ctx.closePath();
  }

  async function fetchJSON(url){
    const r = await fetch(url, { headers:{accept:"application/json"}, cache:"no-store" });
    const txt = await r.text();
    const ct = (r.headers.get("content-type")||"").toLowerCase();
    if (!ct.includes("application/json")) throw new Error(`Ekki JSON frá ${url}\n${txt.slice(0,220)}`);

    let j;
    try { j = JSON.parse(txt); }
    catch { throw new Error(`Ógilt JSON frá ${url}\n${txt.slice(0,220)}`); }

    if (!r.ok || j.ok === false) {
      const dbg = j?.debug ? ("\n\nDEBUG:\n" + j.debug) : "";
      throw new Error(`API villa: ${j?.error || r.status}${dbg}`);
    }
    return j;
  }

  const COLORS = {
    mercury: "rgba(251,191,36,0.85)",
    venus:   "rgba(167,139,250,0.85)",
    earth:   "rgba(34,211,238,0.90)",
    mars:    "rgba(74,222,128,0.90)",
    jupiter: "rgba(255,255,255,0.70)",
    saturn:  "rgba(255,255,255,0.55)",
  };
  const LABELS = {
    mercury:"Merkúr",
    venus:"Venus",
    earth:"Jörð",
    mars:"Mars",
    jupiter:"Júpíter",
    saturn:"Satúrnus",
  };

  function drawSun(center){
    const glow = ctx.createRadialGradient(center.x,center.y,0, center.x,center.y,150);
    glow.addColorStop(0,"rgba(251,191,36,0.35)");
    glow.addColorStop(1,"rgba(0,0,0,0)");
    ctx.fillStyle = glow;
    ctx.beginPath(); ctx.arc(center.x,center.y,140,0,Math.PI*2); ctx.fill();

    ctx.fillStyle = "rgba(251,191,36,0.90)";
    ctx.beginPath(); ctx.arc(center.x,center.y,10,0,Math.PI*2); ctx.fill();
  }

  function drawDot(p, center, scale, r, fill, label){
    const s = { x:center.x + p.x*scale, y:center.y + p.y*scale };
    ctx.fillStyle = fill;
    ctx.beginPath(); ctx.arc(s.x,s.y,r,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,0.22)";
    ctx.lineWidth = 1;
    ctx.stroke();

    if (label){
      ctx.font = "600 12px system-ui";
      ctx.fillStyle = "rgba(234,240,255,0.75)";
      ctx.fillText(label, s.x + 10, s.y - 10);
    }
    return s;
  }

  function drawOrbit(series, center, scale, stroke){
    ctx.strokeStyle = stroke;
    ctx.lineWidth = 1;
    ctx.beginPath();
    for (let i=0;i<series.length;i++){
      const p = series[i];
      const s = { x:center.x + p.x*scale, y:center.y + p.y*scale };
      if (i===0) ctx.moveTo(s.x,s.y); else ctx.lineTo(s.x,s.y);
    }
    ctx.stroke();
  }

  function drawMoonDisk(moonS, lightDir, illum){
    const L = vNorm(lightDir);
    const r = 7;

    ctx.save();
    ctx.beginPath(); ctx.arc(moonS.x, moonS.y, r, 0, Math.PI*2);
    ctx.clip();

    const g = ctx.createRadialGradient(moonS.x-r*0.2, moonS.y-r*0.2, r*0.2, moonS.x, moonS.y, r);
    g.addColorStop(0,"rgba(255,255,255,0.18)");
    g.addColorStop(1,"rgba(0,0,0,0.30)");
    ctx.fillStyle=g;
    ctx.fillRect(moonS.x-r, moonS.y-r, r*2, r*2);

    // shadow overlap trick
    const phase = 2*illum - 1; // -1..+1
    const offset = -phase * r;
    ctx.fillStyle="rgba(0,0,0,0.60)";
    ctx.beginPath();
    ctx.arc(moonS.x + L.x*offset, moonS.y + L.y*offset, r, 0, Math.PI*2);
    ctx.fill();

    ctx.restore();
    ctx.strokeStyle="rgba(255,255,255,0.35)";
    ctx.beginPath(); ctx.arc(moonS.x, moonS.y, r, 0, Math.PI*2); ctx.stroke();
  }

  function drawPhaseDiagram(box, centerSun, earthS, moonTrueS){
    // box: {x,y,w,h}
    ctx.save();
    ctx.fillStyle = "rgba(0,0,0,0.22)";
    ctx.strokeStyle = "rgba(255,255,255,0.14)";
    ctx.lineWidth = 1;
    roundRect(box.x, box.y, box.w, box.h, 14);
    ctx.fill(); ctx.stroke();

    ctx.fillStyle = "rgba(234,240,255,0.70)";
    ctx.font = "600 11px system-ui";
    ctx.fillText("Fasa-skýring (Sól–Jörð–Tungl)", box.x+12, box.y+18);

    // Map points into box coords (we just reuse actual screen points but clamp-ish by shifting)
    // We'll draw 3 points: Sun at center of box, Earth and Moon relative directions.
    const cx = box.x + box.w*0.50;
    const cy = box.y + box.h*0.62;

    // directions from Earth: Earth->Sun and Earth->Moon (using real positions)
    const eToSun = vSub(centerSun, earthS);
    const eToMoon = vSub(moonTrueS, earthS);

    const u1 = vNorm(eToSun);
    const u2 = vNorm(eToMoon);

    const L = Math.min(box.w, box.h) * 0.28;

    const sunP  = { x: cx + u1.x*L, y: cy + u1.y*L };
    const moonP = { x: cx + u2.x*L, y: cy + u2.y*L };
    const earthP= { x: cx, y: cy };

    // rays
    ctx.strokeStyle = "rgba(255,255,255,0.20)";
    ctx.beginPath(); ctx.moveTo(earthP.x, earthP.y); ctx.lineTo(sunP.x, sunP.y); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(earthP.x, earthP.y); ctx.lineTo(moonP.x, moonP.y); ctx.stroke();

    // angle arc
    const ang = vAngle(eToSun, eToMoon);
    ctx.strokeStyle = "rgba(34,211,238,0.55)";
    ctx.beginPath();
    ctx.arc(earthP.x, earthP.y, 22, Math.atan2(u1.y,u1.x), Math.atan2(u2.y,u2.x), false);
    ctx.stroke();

    ctx.fillStyle = "rgba(234,240,255,0.65)";
    ctx.font = "600 11px system-ui";
    ctx.fillText(`α ≈ ${(ang*180/Math.PI).toFixed(1)}°`, box.x+12, box.y+box.h-12);

    // dots
    ctx.fillStyle = "rgba(34,211,238,0.95)";
    ctx.beginPath(); ctx.arc(earthP.x, earthP.y, 4.5, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "rgba(251,191,36,0.90)";
    ctx.beginPath(); ctx.arc(sunP.x, sunP.y, 4.5, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "rgba(255,255,255,0.90)";
    ctx.beginPath(); ctx.arc(moonP.x, moonP.y, 4.0, 0, Math.PI*2); ctx.fill();

    // labels
    ctx.fillStyle = "rgba(234,240,255,0.60)";
    ctx.font = "600 10px system-ui";
    ctx.fillText("Jörð", earthP.x+8, earthP.y-8);
    ctx.fillText("Sól",  sunP.x+8, sunP.y-8);
    ctx.fillText("Tungl", moonP.x+8, moonP.y-8);

    ctx.restore();
  }

  // --- state ---
  let startISO = "2026-02-02"; // stabilt demo; þú getur sett isoToday() ef þú vilt live
  let ep = null;
  let mo = null;

  function selectedBodies(){
    return Array.from(document.querySelectorAll('input.body:checked')).map(x=>x.value);
  }

  function setStatusOk(metaA, metaB){
    const bits = [];
    if (metaA?.cache) bits.push(`ep:${metaA.cache}${metaA.stale?"/stale":""}`);
    if (metaB?.cache) bits.push(`moon:${metaB.cache}${metaB.stale?"/stale":""}`);
    el.status.textContent = bits.length ? `ok ✅ (${bits.join(", ")})` : "ok ✅";
  }

  function setStatusLoading(msg){ el.status.textContent = msg || "sæki…"; }

  function showError(e){
    el.err.style.display="block";
    el.errtxt.textContent = String(e?.message || e);
  }
  function clearError(){
    el.err.style.display="none";
    el.errtxt.textContent = "";
  }

  function showNote(html){
    el.oknote.style.display="block";
    el.oknote.innerHTML = html;
  }
  function hideNote(){
    el.oknote.style.display="none";
    el.oknote.innerHTML = "";
  }

  function sample(series, iFloat){
    const n = series.length;
    if (!n) return {x:0,y:0};
    const i = Math.floor(iFloat);
    const t = iFloat - i;
    const i0 = clamp(i, 0, n-1);
    const i1 = clamp(i+1, 0, n-1);
    const a = series[i0], b = series[i1];
    return { x: lerp(a.x,b.x,t), y: lerp(a.y,b.y,t) };
  }

  async function load(){
    clearError();
    hideNote();
    setStatusLoading("sæki…");

    const days = parseInt(el.days.value, 10);
    el.daysLabel.textContent = String(days);
    el.t.max = String(Math.max(0, days-1));
    if (parseInt(el.t.value,10) > days-1) el.t.value = "0";
    el.tLabel.textContent = el.t.value;

    const bodies = selectedBodies();
    if (!bodies.includes("earth")) {
      showNote(`Ath: þú slökktir á <b>Jörð</b>. Tunglið þarf Jörð til að reikna MoonHelio og fasa. Ég læt Jörð samt vera í bakgrunnsgögnum.`);
    }

    // Ensure Earth is always fetched (for MoonHelio + phase) even if not drawn.
    const fetchBodies = Array.from(new Set([...bodies, "earth"]));

    const epUrl = `/api/ephemeris?start=${encodeURIComponent(startISO)}&days=${days}&step=1d&bodies=${encodeURIComponent(fetchBodies.join(","))}`;
    const moUrl = `/api/moon?start=${encodeURIComponent(startISO)}&days=${days}&step=1d`;

    const [epData, moData] = await Promise.all([ fetchJSON(epUrl), fetchJSON(moUrl) ]);

    ep = epData;
    mo = moData;

    const N = Math.min(ep.count||0, (ep.dates||[]).length, mo.count||0, days);
    if (N < 1) throw new Error(`Of lítil gögn: ep.count=${ep.count}, moon.count=${mo.count}`);

    // If API returned stale, show a friendly banner
    const stale = !!(ep.meta?.stale || mo.meta?.stale);
    if (stale) {
      showNote(`Horizons var líklega í 503-stuði — sýni <b>stale cache</b> (síðustu góðu gögn).`);
    }

    setStatusOk(ep.meta, mo.meta);
    render();
  }

  function render(){
    if (!ep || !mo) return;

    const w = cv.getBoundingClientRect().width;
    const h = cv.getBoundingClientRect().height;
    ctx.clearRect(0,0,w,h);

    const days = parseInt(el.days.value,10);
    const i = clamp(parseInt(el.t.value,10), 0, days-1);
    el.tLabel.textContent = String(i);

    const date = ep.dates?.[i] || ep.start || startISO;
    el.day.textContent = date;

    // world center
    const center = { x: w*0.52, y: h*0.52 };

    // compute max radius among selected planets for scaling (use fetched series)
    let maxR = 0.2;
    for (const [id, series] of Object.entries(ep.series || {})) {
      // only scale by planets we might show OR earth (to keep stable)
      if (!series?.length) continue;
      if (id !== "earth" && !selectedBodies().includes(id)) continue;
      for (const p of series) {
        const r = Math.hypot(p.x,p.y);
        if (r > maxR) maxR = r;
      }
    }
    const scale = (Math.min(w,h)*0.42) / (maxR*1.05);

    // sun
    drawSun(center);

    // orbits
    const showOrbits = el.showOrbits.checked;
    const bodies = selectedBodies();

    if (showOrbits){
      for (const id of bodies){
        const series = ep.series?.[id];
        if (!series) continue;
        const c = (COLORS[id] || "rgba(255,255,255,0.5)");
        // fade for orbit
        const stroke = c.replace("0.90","0.18").replace("0.85","0.18").replace("0.70","0.12").replace("0.55","0.10");
        drawOrbit(series.slice(0, days), center, scale, stroke);
      }
    }

    // planets at day i
    const earth = sample(ep.series.earth, i);
    const earthS = drawDot(earth, center, scale, 5, COLORS.earth, bodies.includes("earth") ? "Jörð" : "");

    for (const id of bodies){
      if (id === "earth") continue;
      const series = ep.series?.[id];
      if (!series) continue;
      const p = sample(series, i);
      const r = (id==="jupiter") ? 6 : (id==="saturn") ? 5 : (id==="mercury") ? 3.5 : 4.5;
      drawDot(p, center, scale, r, COLORS[id] || "rgba(255,255,255,0.7)", LABELS[id] || id);
    }

    // Moon + phase
    const moonGeo = sample(mo.series.moon, i);
    const dAU = vLen(moonGeo);
    el.distAU.textContent = dAU.toFixed(6);
    el.distKM.textContent = Math.round(dAU * AU_KM).toLocaleString("is-IS");

    const moonHelio = vAdd(earth, moonGeo);

    // phase (illum)
    const moonToSun   = vMul(moonHelio, -1); // Sun at origin
    const moonToEarth = vMul(moonGeo, -1);   // Earth relative to Moon
    const alpha = vAngle(moonToSun, moonToEarth);
    const illum = (1 - Math.cos(alpha)) / 2;

    el.illum.textContent = (illum*100).toFixed(1) + "%";
    el.phase.textContent = phaseName(illum);

    if (el.showMoon.checked){
      // true heliocentric moon pixel
      const moonTrueS = { x:center.x + moonHelio.x*scale, y:center.y + moonHelio.y*scale };

      // visible (exaggerated) moon offset around earth
      const exaggeration = 9000;
      const moonVisS = {
        x: earthS.x + moonGeo.x*scale*exaggeration,
        y: earthS.y + moonGeo.y*scale*exaggeration
      };

      // Earth->Moon line (visible)
      ctx.strokeStyle="rgba(255,255,255,0.14)";
      ctx.beginPath(); ctx.moveTo(earthS.x,earthS.y); ctx.lineTo(moonVisS.x,moonVisS.y); ctx.stroke();

      // light direction should be from Moon towards Sun using true direction
      const lightDir = vSub(center, moonTrueS);
      drawMoonDisk(moonVisS, lightDir, illum);

      // mark true moon location if enabled
      if (el.showMoonTrue.checked){
        ctx.fillStyle="rgba(255,255,255,0.28)";
        ctx.beginPath(); ctx.arc(moonTrueS.x, moonTrueS.y, 2.3, 0, Math.PI*2); ctx.fill();
      }

      // Phase diagram inset
      if (el.showPhaseDiagram.checked){
        drawPhaseDiagram(
          { x: 14, y: h - 170 - 14, w: 320, h: 170 },
          center,
          earthS,
          moonTrueS
        );
      }

      // Tiny label for moon vis
      ctx.fillStyle="rgba(234,240,255,0.55)";
      ctx.font="600 11px system-ui";
      ctx.fillText("Tungl (stækkað)", moonVisS.x + 10, moonVisS.y + 14);
    }

    // bottom hint
    ctx.fillStyle="rgba(234,240,255,0.38)";
    ctx.font="600 11px system-ui";
    ctx.fillText("x,y í AU (ecliptic). Sporbaugar = sýnilegar slóðir yfir valinn days-glugga.", 14, 18);
  }

  // --- UI wiring ---
  function attach(){
    el.days.addEventListener("input", () => {
      el.daysLabel.textContent = el.days.value;
      el.t.max = String(Math.max(0, parseInt(el.days.value,10)-1));
    });

    el.days.addEventListener("change", () => load().catch(onFail));
    el.t.addEventListener("input", () => { el.tLabel.textContent = el.t.value; render(); });

    document.querySelectorAll("input.body").forEach(cb => {
      cb.addEventListener("change", () => load().catch(onFail));
    });

    [el.showOrbits, el.showMoon, el.showMoonTrue, el.showPhaseDiagram].forEach(x => {
      x.addEventListener("change", () => render());
    });

    el.today.addEventListener("click", () => { startISO = isoToday(); load().catch(onFail); });
    el.reload.addEventListener("click", () => load().catch(onFail));

    el.prev.addEventListener("click", () => {
      el.t.value = String(clamp(parseInt(el.t.value,10)-1, 0, parseInt(el.t.max,10)));
      el.tLabel.textContent = el.t.value;
      render();
    });
    el.next.addEventListener("click", () => {
      el.t.value = String(clamp(parseInt(el.t.value,10)+1, 0, parseInt(el.t.max,10)));
      el.tLabel.textContent = el.t.value;
      render();
    });
  }

  function onFail(e){
    el.status.textContent = "villa ❌";
    showError(e);
    console.error(e);
  }

  attach();

  // boot
  el.daysLabel.textContent = el.days.value;
  el.t.max = String(Math.max(0, parseInt(el.days.value,10)-1));
  el.tLabel.textContent = el.t.value;

  load().catch(onFail);
})();
</script>
</body>
</html>
