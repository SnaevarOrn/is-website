<!doctype html>
<html lang="is">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sólkerfi — 1 dagur (Horizons)</title>
  <style>
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#070a18; color:#eaf0ff;}
    .wrap{max-width:900px; margin:0 auto; padding:18px; display:grid; gap:12px;}
    .card{border:1px solid rgba(255,255,255,.14); border-radius:16px; overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));}
    .hd{padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.14); color:rgba(255,255,255,.75); font-size:12px; letter-spacing:.35px; text-transform:uppercase; display:flex; justify-content:space-between; gap:10px;}
    .bd{padding:14px; display:grid; gap:10px;}
    canvas{width:100%; height:520px; display:block; border-radius:14px; border:1px solid rgba(255,255,255,.14);
      background:radial-gradient(700px 340px at 50% 45%, rgba(255,255,255,.06), transparent 60%), rgba(0,0,0,.18);}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .chip{border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.05); border-radius:999px; padding:6px 10px; font-size:12px; color:rgba(255,255,255,.75);}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .err{display:none; border:1px solid rgba(251,113,133,.35); background:rgba(251,113,133,.08); border-radius:14px; padding:12px;}
    .err pre{white-space:pre-wrap; word-break:break-word; font-size:12px; margin:8px 0 0;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="hd">
      <div>Horizons: 1 dagur</div>
      <div id="status" class="mono">sæki…</div>
    </div>
    <div class="bd">
      <div class="err" id="err"><b>Villa</b><pre id="errtxt"></pre></div>

      <div class="row">
        <span class="chip">Dagur: <b id="day">—</b></span>
        <span class="chip">Moon (geo AU): <span class="mono" id="moonvec">—</span></span>
        <span class="chip">Illum: <b id="illum">—</b></span>
      </div>

      <canvas id="cv"></canvas>

      <div class="chip">
        Við lesum: <span class="mono">EarthHelio(x,y)</span>, <span class="mono">MarsHelio(x,y)</span>, <span class="mono">MoonGeo(x,y)</span>.
        Síðan: <span class="mono">MoonHelio = EarthHelio + MoonGeo</span>.
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d");

  const el = {
    status: document.getElementById("status"),
    err: document.getElementById("err"),
    errtxt: document.getElementById("errtxt"),
    day: document.getElementById("day"),
    moonvec: document.getElementById("moonvec"),
    illum: document.getElementById("illum"),
  };

  function resize(){
    const r = cv.getBoundingClientRect();
    const dpr = Math.max(1, devicePixelRatio || 1);
    cv.width  = Math.floor(r.width * dpr);
    cv.height = Math.floor(r.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener("resize", resize); resize();

  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  const vAdd = (a,b)=>({x:a.x+b.x, y:a.y+b.y});
  const vMul = (a,s)=>({x:a.x*s, y:a.y*s});
  const vLen = (a)=>Math.hypot(a.x,a.y);
  const vNorm = (a)=>{ const L=vLen(a)||1; return {x:a.x/L,y:a.y/L}; };
  const vDot = (a,b)=>a.x*b.x + a.y*b.y;
  const vAngle = (a,b)=>Math.acos(clamp(vDot(vNorm(a),vNorm(b)),-1,1));

  async function fetchJSON(url){
    const r = await fetch(url, { headers:{accept:"application/json"}, cache:"no-store" });
    const txt = await r.text();
    const ct = (r.headers.get("content-type")||"").toLowerCase();
    if (!ct.includes("application/json")) throw new Error(`Ekki JSON frá ${url}\n${txt.slice(0,200)}`);
    const j = JSON.parse(txt);
    if (!r.ok || j.ok === false) throw new Error(`API: ${j.error||r.status}\n${j.debug||""}`);
    return j;
  }

  function drawSun(center){
    const glow = ctx.createRadialGradient(center.x,center.y,0, center.x,center.y,110);
    glow.addColorStop(0,"rgba(251,191,36,0.35)");
    glow.addColorStop(1,"rgba(0,0,0,0)");
    ctx.fillStyle = glow;
    ctx.beginPath(); ctx.arc(center.x,center.y,100,0,Math.PI*2); ctx.fill();

    ctx.fillStyle = "rgba(251,191,36,0.9)";
    ctx.beginPath(); ctx.arc(center.x,center.y,10,0,Math.PI*2); ctx.fill();
  }

  function drawBody(p, center, scale, r, fill, label){
    const s = { x:center.x + p.x*scale, y:center.y + p.y*scale };
    ctx.fillStyle = fill;
    ctx.beginPath(); ctx.arc(s.x,s.y,r,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,0.25)";
    ctx.stroke();

    if (label){
      ctx.font = "600 12px system-ui";
      ctx.fillStyle = "rgba(234,240,255,0.75)";
      ctx.fillText(label, s.x + 10, s.y - 10);
    }
    return s;
  }

  function drawMoonDisk(moonS, lightDir, illum){
    const L = vNorm(lightDir);
    const r = 6;

    ctx.save();
    ctx.beginPath(); ctx.arc(moonS.x, moonS.y, r, 0, Math.PI*2);
    ctx.clip();

    const g = ctx.createRadialGradient(moonS.x-r*0.2, moonS.y-r*0.2, r*0.2, moonS.x, moonS.y, r);
    g.addColorStop(0,"rgba(255,255,255,0.18)");
    g.addColorStop(1,"rgba(0,0,0,0.30)");
    ctx.fillStyle=g;
    ctx.fillRect(moonS.x-r, moonS.y-r, r*2, r*2);

    const phase = 2*illum - 1;      // -1..+1
    const offset = -phase * r;      // shift shadow
    ctx.fillStyle="rgba(0,0,0,0.60)";
    ctx.beginPath();
    ctx.arc(moonS.x + L.x*offset, moonS.y + L.y*offset, r, 0, Math.PI*2);
    ctx.fill();

    ctx.restore();
    ctx.strokeStyle="rgba(255,255,255,0.35)";
    ctx.beginPath(); ctx.arc(moonS.x, moonS.y, r, 0, Math.PI*2); ctx.stroke();
  }

  async function main(){
    try{
      el.status.textContent = "sæki…";
      el.err.style.display = "none";

      const start = new Date().toISOString().slice(0,10);
      const epUrl = `/api/ephemeris?start=${encodeURIComponent(start)}&days=1&step=1d&bodies=earth,mars`;
      const moUrl = `/api/moon?start=${encodeURIComponent(start)}&days=1&step=1d`;

      const [ep, mo] = await Promise.all([ fetchJSON(epUrl), fetchJSON(moUrl) ]);

      // N = min(counts/dates) — tryggir að við lesum ekki út fyrir
      const N = Math.min(ep.count||0, (ep.dates||[]).length, mo.count||0);
      if (N < 1) throw new Error(`Of lítil gögn: ep.count=${ep.count}, moon.count=${mo.count}`);

      const earth = ep.series.earth[0];
      const mars  = ep.series.mars[0];
      const moonGeo = mo.series.moon[0];
      const moonHelio = vAdd(earth, moonGeo);

      el.day.textContent = ep.dates[0] || ep.start || start;
      el.moonvec.textContent = `${moonGeo.x.toFixed(6)}, ${moonGeo.y.toFixed(6)}`;

      // illumination (0..1): angle at Moon between (moon->sun) and (moon->earth)
      const moonToSun   = vMul(moonHelio, -1); // Sun at origin
      const moonToEarth = vMul(moonGeo, -1);   // Earth relative to Moon
      const alpha = vAngle(moonToSun, moonToEarth);
      const illum = (1 - Math.cos(alpha)) / 2;
      el.illum.textContent = `${(illum*100).toFixed(0)}%`;

      // Draw
      const w = cv.getBoundingClientRect().width;
      const h = cv.getBoundingClientRect().height;
      ctx.clearRect(0,0,w,h);
      const center = { x:w*0.52, y:h*0.52 };

      // scale: show Mars if present
      const maxR = Math.max(vLen(earth), vLen(mars), vLen(moonHelio));
      const scale = (Math.min(w,h)*0.42) / (maxR*1.05);

      drawSun(center);

      const earthS = drawBody(earth, center, scale, 5, "rgba(34,211,238,0.9)", "Jörð");
      drawBody(mars,  center, scale, 5, "rgba(74,222,128,0.9)", "Mars");

      // line Earth->Moon
      const moonS = { x:center.x + moonHelio.x*scale, y:center.y + moonHelio.y*scale };
      ctx.strokeStyle="rgba(255,255,255,0.12)";
      ctx.beginPath(); ctx.moveTo(earthS.x,earthS.y); ctx.lineTo(moonS.x,moonS.y); ctx.stroke();

      // light direction: from Moon to Sun on screen
      const lightDir = { x:center.x - moonS.x, y:center.y - moonS.y };
      drawMoonDisk(moonS, lightDir, illum);

      el.status.textContent = "ok ✅";
    } catch (e){
      el.status.textContent = "villa ❌";
      el.err.style.display = "block";
      el.errtxt.textContent = String(e?.message || e);
      console.error(e);
    }
  }

  main();
})();
</script>
</body>
</html>
